import java.io.*;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.*;
import javax.swing.JOptionPane;

public class EMSApp {

    // -------------------------
    // Models
    // -------------------------
    public static class User {
        public String id, name, email, password, role;
        public User(String id, String name, String email, String password, String role){
            this.id=id; this.name=name; this.email=email; this.password=password; this.role=role;
        }
        @Override public String toString(){ return name + " (" + role + ")"; }
    }

    public static class Booking {
        public String reservation, customerId, eventName, details, status, assignedSP, pmId;
        public LocalDate date;
        public double price;
        public Booking(){}
        public Booking(String reservation, String customerId, String eventName, String details, LocalDate date){
            this.reservation=reservation; this.customerId=customerId; this.eventName=eventName;
            this.details=details; this.date=date; this.status="NEW"; this.price=0;
            this.assignedSP=""; this.pmId="";
        }
    }

    public static class Message {
        public String fromId, toId, text;
        public LocalDateTime timestamp;
        public Message(String f,String t,String text){ this.fromId=f; this.toId=t; this.text=text; this.timestamp=LocalDateTime.now(); }
    }

    // -------------------------
    // Data Store
    // -------------------------
    public static class DataStore {
        public static final String DIR="data";
        public static final String USERS_FILE=DIR+"/users.txt";
        public static final String BOOKINGS_FILE=DIR+"/bookings.txt";
        public static final String MESSAGES_FILE=DIR+"/messages.txt";
        public static final String EMAIL_LOG=DIR+"/sent_emails.txt";

        public static List<User> users = new ArrayList<>();
        public static List<Booking> bookings = new ArrayList<>();
        public static List<Message> messages = new ArrayList<>();

        public static void ensureDir(){ new File(DIR).mkdirs(); }
        public static void loadAll(){ ensureDir(); loadUsers(); loadBookings(); loadMessages(); }
        public static void saveAll(){ ensureDir(); saveUsers(); saveBookings(); saveMessages(); }

        // Users
        public static void saveUsers(){
            try(PrintWriter pw=new PrintWriter(new FileWriter(USERS_FILE))){
                for(User u: users) pw.printf("%s|%s|%s|%s|%s%n", u.id,u.name,u.email,u.password,u.role);
            }catch(Exception e){ e.printStackTrace(); }
        }
        public static void loadUsers(){
            users.clear(); File f=new File(USERS_FILE); if(!f.exists()) return;
            try(BufferedReader br=new BufferedReader(new FileReader(f))){
                String line; while((line=br.readLine())!=null){
                    if(line.trim().isEmpty()) continue; String[] p=line.split("\\|");
                    if(p.length<5) continue; users.add(new User(p[0],p[1],p[2],p[3],p[4]));
                }
            }catch(Exception e){ e.printStackTrace(); }
        }

        // Bookings
        public static void saveBookings(){
            try(PrintWriter pw=new PrintWriter(new FileWriter(BOOKINGS_FILE))){
                for(Booking b: bookings)
                    pw.printf("%s|%s|%s|%s|%s|%s|%s|%s|%s%n",
                        b.reservation,b.customerId,b.eventName,b.details,b.date.toString(),
                        b.status,b.price,b.assignedSP,b.pmId);
            }catch(Exception e){ e.printStackTrace(); }
        }
        public static void loadBookings(){
            bookings.clear(); File f=new File(BOOKINGS_FILE); if(!f.exists()) return;
            try(BufferedReader br=new BufferedReader(new FileReader(f))){
                String line; while((line=br.readLine())!=null){
                    if(line.trim().isEmpty()) continue;
                    String[] p=line.split("\\|"); if(p.length<9) continue;
                    Booking b = new Booking();
                    b.reservation=p[0]; b.customerId=p[1]; b.eventName=p[2]; b.details=p[3]; b.date=LocalDate.parse(p[4]);
                    b.status=p[5]; b.price=Double.parseDouble(p[6]); b.assignedSP=p[7]; b.pmId=p[8];
                    bookings.add(b);
                }
            }catch(Exception e){ e.printStackTrace(); }
        }

        // Messages
        public static void saveMessages(){
            try(PrintWriter pw=new PrintWriter(new FileWriter(MESSAGES_FILE))){
                for(Message m: messages) pw.printf("%s|%s|%s|%s%n", m.fromId,m.toId,m.text,m.timestamp.toString());
            }catch(Exception e){ e.printStackTrace(); }
        }
        public static void loadMessages(){
            messages.clear(); File f=new File(MESSAGES_FILE); if(!f.exists()) return;
            try(BufferedReader br=new BufferedReader(new FileReader(f))){
                String line; while((line=br.readLine())!=null){
                    if(line.trim().isEmpty()) continue;
                    String[] p=line.split("\\|"); if(p.length<4) continue;
                    Message m=new Message(p[0],p[1],p[2]); m.timestamp=LocalDateTime.parse(p[3]);
                    messages.add(m);
                }
            }catch(Exception e){ e.printStackTrace(); }
        }

        // Find
        public static Optional<User> findByEmail(String email){ return users.stream().filter(u->u.email.equalsIgnoreCase(email)).findFirst(); }
        public static Optional<User> findById(String id){ return users.stream().filter(u->u.id.equals(id)).findFirst(); }
        public static Optional<Booking> findBooking(String reservation){ return bookings.stream().filter(b->b.reservation.equals(reservation)).findFirst(); }

        public static void sendEmail(String to,String subject,String body){
            ensureDir();
            try(FileWriter fw=new FileWriter(EMAIL_LOG,true)){ fw.write("To:"+to+"\nSubject:"+subject+"\n"+body+"\n----\n"); }
            catch(Exception e){ e.printStackTrace(); }
            JOptionPane.showMessageDialog(null,"Simulated email logged to "+EMAIL_LOG,"Email",JOptionPane.INFORMATION_MESSAGE);
        }
    }

    public static String genId(String prefix){ return prefix+"-"+UUID.randomUUID().toString().substring(0,8).toUpperCase(); }

    public static void ensureDefaultAdminAndSample(){
        if(DataStore.users.isEmpty()){
            DataStore.users.add(new User("admin","Administrator","admin@example.com","admin","ADMIN"));
            DataStore.users.add(new User("pm1","ProjectManager One","pm1@example.com","pm1","PM"));
            DataStore.users.add(new User("sp1","ServiceProvider One","sp1@example.com","sp1","SP"));
            DataStore.saveAll();
        }
    }

    public static void main(String[] args){
        DataStore.loadAll();
        ensureDefaultAdminAndSample();
        EMSGUI.launchGUI();
    }
}
